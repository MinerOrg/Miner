name: Setup Release Bundle
on:
  release:
    types: [published]

jobs:
  bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full repo with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Create zip with assets
        run: zip -r release.zip .

      - name: Setup Unreal Engine path
        run: |
          echo "UE_PATH=C:\Program Files\Epic Games\UE_5.4" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Verify Unreal Build Tool
        run: |
          dir "$env:UE_PATH\Engine\Binaries\DotNET"
        shell: pwsh

      # --- CLIENT BUILD ---
      - name: Build Client
        run: |
          & "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
            -project="$(Get-Location)\YourGame.uproject" `
            -noP4 `
            -clientconfig=Shipping `
            -serverconfig=Shipping `
            -targetplatform=Win64 `
            -build `
            -cook `
            -stage `
            -pak `
            -archive `
            -archivedirectory="$(Get-Location)\Build\Client"
        shell: pwsh

      # --- SERVER BUILD ---
      - name: Build Server
        run: |
          & "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
            -project="$(Get-Location)\YourGame.uproject" `
            -noP4 `
            -server `
            -clientconfig=Shipping `
            -serverconfig=Shipping `
            -targetplatform=Win64 `
            -build `
            -cook `
            -stage `
            -pak `
            -archive `
            -archivedirectory="$(Get-Location)\Build\Server"
        shell: pwsh

      # --- PACKAGE BUILDS ---
      - name: Zip Builds
        run: |
          Compress-Archive -Path .\Build\Client\* -DestinationPath Client.zip
          Compress-Archive -Path .\Build\Server\* -DestinationPath Server.zip
        shell: pwsh

      # --- UPLOAD TO RELEASE ---
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Client.zip
            Server.zip
            full-source.zip
